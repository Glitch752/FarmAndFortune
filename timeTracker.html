<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milkyway time tracker</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #090909;
            text-align: center;
            color: #e9e9e9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100%;
            overflow: hidden;

            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin: 0;
            padding-bottom: 2rem;
        }

        .settings {
            position: absolute;
            left: 0;
            bottom: 0;
            text-align: left;
            margin: 20px;
        }
        .settings p {
            font-size: 1.2em;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }
        .settings span, .settings a {
            font-weight: normal;
        }
        .settings button {
            margin-left: 10px;
            font-size: 1rem;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .settings .invalid {
            color: #f55;
            display: none;
            margin-left: 10px;
        }

        .panel-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 1rem;
        }

        .panel {
            background-color: #191919;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            width: 250px;
            position: relative;
            padding-bottom: 15px;
        }
        .panel .title {
            display: block;
            font-size: 1.1rem;
            margin: 10px;
        }
        .panel a {
            color: #6db170;
        }
        .panel .value {
            font-size: 2em;
            font-weight: bold;
            padding: 0;
            margin: 0.5rem 0;
        }
        .panel progress {
            --color: #4caf50;

            height: 10px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;

            border-radius: 100px;
            background-color: #333;
            border: none;
        }
        .panel progress::-webkit-progress-bar {
            border-radius: 100px;
            background-color: #333;
        }
        .panel progress::-webkit-progress-value {
            background-color: var(--color);
            border-radius: 100px;
        }
        .panel progress::-moz-progress-bar { /* This can't be combined with the above because webkit doesn't like it?? */
            background-color: var(--color);
            border-radius: 100px;
        }

        .commits {
            margin-top: 30px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 60vw;
            padding: 10px;
            gap: 5px;
        }
        .commits::-webkit-scrollbar {
            background-color: #222;
            width: 5px;
        }
        .commits::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 10px;
        }
        .commit {
            background-color: #191919;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            padding: 5px 8px;
            display: flex;
            flex-direction: row;
            align-items: center;
            text-decoration: none;
        }
        .commit .commit-time {
            flex-shrink: 0;
            margin-left: 2rem;
            color: #666;
        }
        .commit .commit-message {
            color: #ccc;
            font-size: 0.9rem;
            font-style: italic;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        

        .reloading {
            margin-top: 20px;
            font-style: italic;
            color: #888;
            display: none;
        }
        .last-updated {
            position: absolute;
            right: 0;
            bottom: 0;
            margin: 20px;
            font-size: 0.9em;
            color: #888;
        }
        .last-updated button {
            font-size: 0.9em;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
        }
        .last-updated button:disabled {
            color: #666;
            cursor: default;
        }
    </style>
</head>
<body>
    <h1>Milkyway Time Tracker</h1>

    <div class="panel-row">
        <div class="panel">
            <span class="title">Last commit time</span>
            <p class="value" id="time-since-last-update">-</p>
        </div>
        <div class="panel">
            <span class="title">
                <a href="-" id="commits-link">Commits</a>
            </span>
            <p class="value" id="total-commits">-</p>
        </div>
    </div>
    <div class="panel-row">
        <div class="panel">
            <span class="title">Hackatime since last commit</span>
            <p class="value" id="hackatime-since-last-commit">-</p>
            <progress id="progress-time-since-last-commit" value="0" max="100" style="width: 100%;"></progress>
        </div>
        <div class="panel">
            <span class="title">Total tracked on hackatime</span>
            <p class="value" id="total-hackatime-time">-</p>
        </div>
    </div>
    <div class="commits">
        <a class="commit" href="-">
            <span class="commit-message">-</span>
            <span class="commit-time">-</span>
        </a>
    </div>

    <p class="reloading" id="reloading">Reloading data. This may take a bit.</p>

    <p class="last-updated">
        <button id="refresh">Refresh</button>
        <span id="last-updated">Last updated: never</span>
    </p>

    <div class="settings">
        <p>
            Hackatime API key: <span id="api-key"></span>
            <button id="edit-api-key">Change</button>
            <span class="invalid" id="invalid-api-key">Invalid API key</span>
            <span class="invalid" id="hackatime-down">Hackatime API down :(</span>
        </p>
        <p>
            Hackatime project: <span id="hackatime-project-name"></span>
            <button id="edit-hackatime-project">Change</button>
            <span class="invalid" id="invalid-hackatime-project">Invalid project</span>
        </p>
        <p>
            GitHub repo: <span id="github-repo"></span>
            <button id="edit-github-repo">Change</button>
            <span class="invalid" id="invalid-github-repo">Invalid repo</span>
        </p>
        <p>
            Notifications: <span id="notification-permission">...</span>
            <button id="request-notification-permission">Request</button>
        </p>
    </div>

    <script>
        const hackatimeCacheDuration = 3 * 60;
        const githubCacheDuration = 3 * 60;

        function loadStorageValue(key, promptText) {
            let value = localStorage.getItem(key);
            while(!value) {
                value = prompt(promptText);
                if(value) localStorage.setItem(key, value);
            }
            return value;
        }

        const apiKey = loadStorageValue('apiKey', 'Please enter your hackatime API key:');
        const projectName = loadStorageValue('hackatimeProject', 'Please enter your hackatime project name:');
        const githubRepo = loadStorageValue('githubRepo', 'Please enter your GitHub repo, in the format `owner/repo`:');
        
        document.getElementById('hackatime-project-name').innerText = projectName;
        document.getElementById('edit-hackatime-project').onclick = () => {
            localStorage.removeItem('hackatimeProjectName');
            location.reload();
        };

        document.getElementById('api-key').innerText = `*******${apiKey.slice(-4)}`;
        document.getElementById('edit-api-key').onclick = () => {
            localStorage.removeItem('apiKey');
            location.reload();
        };

        document.getElementById('github-repo').innerText = githubRepo;
        document.getElementById('edit-github-repo').onclick = () => {
            localStorage.removeItem('githubRepo');
            location.reload();
        };

        const githubRepoRegex = /^[^\/]+\/[^\/]+$/;
        if(!githubRepoRegex.test(githubRepo)) {
            document.getElementById('invalid-github-repo').style.display = 'inline';
            alert('Invalid GitHub repo format! It should be in the format `owner/repo`.');
            localStorage.removeItem('githubRepo');
            location.reload();
        }

        const notificationPermission = Notification.permission;
        const notifPermissionText = document.getElementById('notification-permission');
        const notifRequestButton = document.getElementById('request-notification-permission');
        if(notificationPermission === 'denied') {
            notifPermissionText.innerText = "Denied";
            notifRequestButton.style.display = 'none';
            notifPermissionText.style.color = '#f55';
        } else if(notificationPermission === 'granted') {
            notifPermissionText.innerText = "Granted";
            notifRequestButton.style.display = 'none';
            notifPermissionText.style.color = '#5f5';
        } else {
            notifPermissionText.innerText = "Disabled";
            notifRequestButton.style.display = 'inline';
            notifPermissionText.style.color = '#f55';
        }

        notifRequestButton.onclick = () => {
            Notification.requestPermission().then(() => location.reload());
        };


        const apiBase = `https://hackatime.hackclub.com/api/v1/`;
        async function sendHackatimeRequest(endpoint, cacheDuration = 0, hackatimeCacheKey = "", params = {}) {
            const cacheKey = `hackatime_cache_${hackatimeCacheKey}`;
            const now = Date.now();

            // Check cache
            if(cacheDuration > 0) {
                const cached = localStorage.getItem(cacheKey);
                if(cached) {
                    try {
                        const { data, timestamp } = JSON.parse(cached);
                        if(now - timestamp < cacheDuration * 1000) {
                            console.log('Using cached data for', endpoint);
                            return data;
                        }
                        console.log('Cache expired for', endpoint);
                    } catch (e) {
                        // fall through to fetch
                    }
                }
            }

            // Fetch from API
            params = Object.fromEntries(Object.entries(params).filter(([_, v]) => v != undefined))
            const paramsString = new URLSearchParams(params).toString();
            if(paramsString) endpoint += `?${paramsString}`;
            
            const data = await fetch(`${apiBase}${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            }).then(res => res.json()).catch(() => {
                document.getElementById('hackatime-down').style.display = 'inline';
                return null;
            });
            document.getElementById('hackatime-down').style.display = 'none';

            // cache so we don't spam hackatime
            if(cacheDuration > 0 && data) localStorage.setItem(cacheKey, JSON.stringify({ data, timestamp: now }));

            return data;
        }

        /** @param {string | undefined} start ISO 8601 date string */
        async function getHackatimeTimeBetween(start, end = undefined, cacheKey = `between_${start || 'start'}_${end || 'end'}`) {
            // If the start and end time are less than 2 minutes (idk artitrary limit) apart, skip. Hackatime doesn't like when we ask for very short durations, it seems.
            if(start && end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                if(endDate.getTime() - startDate.getTime() < 2 * 60 * 1000) {
                    console.log("Skipping hackatime query for short duration");
                    return 0;
                }
            }

            const data = await sendHackatimeRequest(`users/my/project/${projectName}`, hackatimeCacheDuration, cacheKey, {
                start_date: start ?? undefined,
                end_date: end ?? undefined
            });
            if(!data) return;

            if(data.error) {
                if(data.error === "User not found") {
                    document.getElementById('invalid-api-key').style.display = 'inline';
                } else if(data.error === "found nuthin") {
                    document.getElementById('invalid-hackatime-project').style.display = 'inline';
                } else {
                    alert(`Error: ${data.error}`);
                }
                return;
            }

            return data.total_seconds;
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if(hours === 0) return `${minutes}m`;
            return `${hours}h ${minutes}m`;
        }
        function formatTimestamp(date) {
            return date.toLocaleString();
        }
        function timeProgressColor(value, max) {
            // Green when < 50%, interpolate to red as approaching 100%, then red for anything over
            if(value >= max) return 'rgb(200, 100, 100)';
            if(value <= max * 0.5) return 'rgb(100, 200, 100)';
            
            const ratio = (value - max / 2) / (max / 2);
            const r = ratio;
            const g = 1 - ratio;
            return `rgb(${r * 100 + 100}, ${g * 100 + 100}, 100)`;
        }

        let hackatimeSecondsAfterLatestCommit = 0;
        let totalHackatimeSeconds = 0;
        let latestCommitTime = null;
        let totalCommits = 0;

        let hackatimeUpdateTime = null;
        let githubUpdateTime = null;

        async function updateHackatime() {
            const data = await sendHackatimeRequest(`users/my/project/${projectName}`, hackatimeCacheDuration, `total_${projectName}`);
            if(!data) {
                document.getElementById('invalid-api-key').style.display = 'inline';
                return;
            }

            if(data.error) {
                if(data.error === "User not found") {
                    document.getElementById('invalid-api-key').style.display = 'inline';
                } else if(data.error === "found nuthin") {
                    document.getElementById('invalid-hackatime-project').style.display = 'inline';
                } else {
                    alert(`Error: ${data.error}`);
                }
                return;
            }

            console.log("Hackatime data loaded", data);

            totalHackatimeSeconds = data.total_seconds || 0;
            // Total hackatime time
            // This only depends on hackatime data so can be updated here
            document.getElementById('total-hackatime-time').innerText = formatTime(totalHackatimeSeconds);

            // Get the hackatime time after the latest commit
            if(latestCommitTime) {
                hackatimeSecondsAfterLatestCommit = await getHackatimeTimeBetween(latestCommitTime.toISOString(), undefined, "after_latest_commit") || 0;
                console.log("Calculated hackatime after latest commit:", hackatimeSecondsAfterLatestCommit);
            } else {
                hackatimeSecondsAfterLatestCommit = 0;
            }

            hackatimeUpdateTime = new Date();
            updateDisplay();
        }

        async function getGithubData() {
            // If cached recently, skip
            if(githubCacheDuration > 0) {
                const cached = localStorage.getItem('github_cache');
                if(cached) {
                    try {
                        const { data, timestamp } = JSON.parse(cached);
                        if(Date.now() - timestamp < githubCacheDuration * 1000) {
                            console.log('Using cached github data');
                            return data;
                        }
                        console.log('Github cache expired');
                    } catch (e) {
                        // fall through to fetch
                    }
                }
            }

            const res = await fetch(
                `https://api.github.com/repos/${githubRepo}/commits?per_page=100`
            ).then(res => res.json()).catch((e) => {
                console.error(e);
                document.getElementById('invalid-shiba-token').style.display = 'inline';
            });

            // cache so we don't spam github
            if(githubCacheDuration > 0 && res) localStorage.setItem('github_cache', JSON.stringify({ data: res, timestamp: Date.now() }));
            return res;
        }

        async function updateGithub() {
            document.getElementById('reloading').style.display = 'block';
            document.getElementById('refresh').disabled = true;

            const data = await getGithubData();
            if(!data || data.message === "Not Found") {
                document.getElementById('invalid-github-repo').style.display = 'inline';
                return;
            }

            console.log("GitHub data loaded", data);

            totalCommits = data.length;
            document.getElementById('total-commits').innerText = totalCommits;

            if(totalCommits > 0) {
                latestCommitTime = new Date(data[0].commit.author.date);
                document.getElementById('commits-link').href = `https://github.com/${githubRepo}/`;
            }

            // Clear existing commits
            const commitsContainer = document.querySelector('.commits');
            commitsContainer.innerHTML = '';
            // Add commits
            data.forEach(commit => {
                const commitElement = document.createElement('a');
                commitElement.className = 'commit';
                commitElement.href = commit.html_url;

                const messageSpan = document.createElement('span');
                messageSpan.className = 'commit-message';
                messageSpan.innerText = commit.commit.message.split('\n')[0];
                commitElement.appendChild(messageSpan);

                const timeSpan = document.createElement('span');
                timeSpan.className = 'commit-time';
                const commitDate = new Date(commit.commit.author.date);
                timeSpan.innerText = commitDate.toLocaleString();
                commitElement.appendChild(timeSpan);

                commitsContainer.appendChild(commitElement);
            });


            githubUpdateTime = new Date();
            updateDisplay();

            document.getElementById('reloading').style.display = 'none';
            document.getElementById('refresh').disabled = false;
        }

        function updateDisplay() {
            // Last commit time
            if(latestCommitTime) {
                const now = new Date();
                const diffMs = now - latestCommitTime;
                const diffMinutes = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);

                let displayText = '';
                if(diffDays > 0) {
                    displayText += `${diffDays}d `;
                }
                if(diffHours % 24 > 0 || diffDays > 0) {
                    displayText += `${diffHours % 24}h `;
                }
                displayText += `${diffMinutes % 60}m ago`;

                document.getElementById('time-since-last-update').innerText = displayText.trim();
            } else {
                document.getElementById('time-since-last-update').innerText = 'No commits found';
            }

            // Total commits
            document.getElementById('total-commits').innerText = totalCommits;

            // Time since last commit
            if(hackatimeSecondsAfterLatestCommit) {
                document.getElementById('hackatime-since-last-commit').innerText = formatTime(hackatimeSecondsAfterLatestCommit);
                const progressElement = document.getElementById('progress-time-since-last-commit');
                progressElement.value = hackatimeSecondsAfterLatestCommit;
                progressElement.max = 60 * 60; // 1 hour
                progressElement.style.setProperty("--color", timeProgressColor(hackatimeSecondsAfterLatestCommit, 60 * 60));
            } else {
                document.getElementById('hackatime-since-last-commit').innerText = '-';
            }

            // Total hackatime time
            document.getElementById('total-hackatime-time').innerText = formatTime(totalHackatimeSeconds);

            // Last updated
            document.getElementById('last-updated').innerText = `Last updated: hackatime ${hackatimeUpdateTime ? hackatimeUpdateTime.toLocaleTimeString() : 'never'}, github ${githubUpdateTime ? githubUpdateTime.toLocaleTimeString() : 'never'}`;
        }

        function sendNotifications() {
            if(notificationPermission === 'granted') {
                if(hackatimeSecondsAfterLatestCommit >= 50 * 60) {
                    console.log('Sending unlogged hackatime notification');
                    new Notification('Milkyway Time Tracker', {
                        body: `You have ${
                            Math.floor(hackatimeSecondsAfterLatestCommit / 60)
                        } minutes hours of unlogged hackatime. Make sure to commit!`,
                        icon: 'https://milkyway.hackclub.com/icon.png'
                    });
                }
            }
        }

        document.getElementById('refresh').onclick = async () => {
            // Clear caches
            localStorage.removeItem('github_cache');
            for(const key in localStorage) {
                if(key.startsWith('hackatime_cache_')) localStorage.removeItem(key);
            }

            await updateGithub();
            await updateHackatime();
        };

        (async () => {
            await updateGithub();
            await updateHackatime();
            sendNotifications();

            setInterval(async () => {
                await updateHackatime();
                sendNotifications();
            }, 3 * 60 * 1000);

            setInterval(async () => {
                await updateGithub();
            }, 15 * 60 * 1000);

            setInterval(() => {
                updateDisplay();
            }, 60 * 1000);
        })()
    </script>
</body>
</html>